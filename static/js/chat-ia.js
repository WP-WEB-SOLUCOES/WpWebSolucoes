// Chat IA Agent - Vers√£o Melhorada com WebSocket Integration
class ChatIA {
    constructor() {
        this.isOpen = false;
        this.messages = [];
        this.isTyping = false;
        this.conversationContext = [];
        this.waitingForHuman = false;
        this.humanChatActive = false; // NOVO: Controla se est√° em modo humano
        this.startTime = Date.now()
        this.pendingHumanTranfer = false;
        this.sessionId = this.getOrCreateSessionId();

        this.initializeChat();
        this.restorePreviousSession(); // NOVO: Restaura sess√£o anterior
    }

    // NOVO: Sistema de sess√£o com cookies
    getOrCreateSessionId() {
        let sessionId = this.getCookie('chat_session_id');
        if (!sessionId) {
            sessionId = 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            this.setCookie('chat_session_id', sessionId, 15); // 15 minutos
        }
        return sessionId;
    }

    setCookie(name, value, minutes) {
        const expires = new Date();
        expires.setTime(expires.getTime() + (minutes * 60 * 1000));
        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
    }

    getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // NOVO: Restaura sess√£o anterior se existir
    restorePreviousSession() {
        const savedState = localStorage.getItem(`chat_state_${this.sessionId}`);
        if (savedState) {
            try {
                const state = JSON.parse(savedState);
                this.humanChatActive = state.humanChatActive || false;
                this.waitingForHuman = state.waitingForHuman || false;

                if (this.humanChatActive) {
                    // Se tinha um chat humano ativo, tenta reconectar
                    setTimeout(() => this.initializeWebSocket(), 1000);
                }
            } catch (e) {
                console.log('N√£o foi poss√≠vel restaurar sess√£o anterior');
            }
        }
    }

    // NOVO: Salva estado atual
    saveState() {
        const state = {
            humanChatActive: this.humanChatActive,
            waitingForHuman: this.waitingForHuman,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem(`chat_state_${this.sessionId}`, JSON.stringify(state));
    }

    // NOVO: Limpa estado (quando chat √© fechado completamente)
    clearState() {
        localStorage.removeItem(`chat_state_${this.sessionId}`);
        this.setCookie('chat_session_id', '', -1); // Expira cookie
    }

    initializeChat() {
        this.createChatHTML();
        this.bindEvents();

        // S√≥ carrega mensagem de boas-vindas se n√£o estiver em modo humano
        if (!this.humanChatActive) {
            this.loadWelcomeMessage();
        }
    }

    createChatHTML() {
        const chatHTML = `
            <div class="chat-widget">
                <div class="chat-container" id="chatContainer">
                    <div class="chat-header">
                        <div class="chat-header-info">
                            <div class="chat-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="chat-agent-info">
                                <h3 id="chatAgentName">Assistente IA</h3>
                                <p id="chatAgentStatus">Online ‚Ä¢ WP Web Solu√ß√µes</p>
                            </div>
                        </div>
                        <button class="chat-close" id="chatClose">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <!-- Mensagens ser√£o inseridas aqui -->
                    </div>

                    <div class="chat-typing" id="chatTyping">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>

                    <div class="chat-transfer" id="chatTransfer">
                        <div class="transfer-message">
                            <i class="fas fa-user-headset"></i>
                            <span>Transferindo para atendente humano...</span>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Digite sua mensagem..." 
                            rows="1"
                        ></textarea>
                        <button class="chat-send" id="chatSend">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <button class="chat-button pulse" id="chatButton">
                    <i class="fas fa-comments"></i>
                </button>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', chatHTML);
    }

    bindEvents() {
        const chatButton = document.getElementById('chatButton');
        const chatClose = document.getElementById('chatClose');
        const chatSend = document.getElementById('chatSend');
        const chatInput = document.getElementById('chatInput');

        chatButton.addEventListener('click', () => this.toggleChat());
        chatClose.addEventListener('click', () => this.closeChat());
        chatSend.addEventListener('click', () => this.sendMessage());

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        chatInput.addEventListener('input', this.autoResize.bind(this));
    }

    autoResize() {
        const textarea = document.getElementById('chatInput');
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
    }

    toggleChat() {
        const chatContainer = document.getElementById('chatContainer');
        const chatButton = document.getElementById('chatButton');

        this.isOpen = !this.isOpen;

        if (this.isOpen) {
            chatContainer.classList.add('active');
            chatButton.classList.remove('pulse');
            document.getElementById('chatInput').focus();

            // Se est√° em modo humano, mostra estado atual
            if (this.humanChatActive) {
                this.updateInterfaceForHumanMode();
            } else if (this.messages.length === 0) {
                this.loadWelcomeMessage();
            }
        } else {
            chatContainer.classList.remove('active');
        }
    }

    closeChat() {
        this.isOpen = false;
        document.getElementById('chatContainer').classList.remove('active');
    }

    loadWelcomeMessage() {
        const welcomeMessage = {
            text: `üëã Ol√°! Sou o **Assistente IA da WP Web Solu√ß√µes**

Estou aqui para ajudar voc√™ com:

üì± **Desenvolvimento** de apps, sites e sistemas
üí∞ **Or√ßamentos** e prazos de entrega
üöÄ **Processo** de desenvolvimento
üë• **Conex√£o** com nossos especialistas

Posso responder perguntas t√©cnicas, explicar nossos servi√ßos ou conectar voc√™ com um atendente humano quando precisar.

**Como posso ajudar voc√™ hoje?**`,
            isBot: true,
            timestamp: new Date()
        };

        this.addMessage(welcomeMessage);
        this.showQuickActions();
    }

    showQuickActions() {
        const quickActions = [
            "üíª Desenvolvimento de Apps",
            "üåê Sites Institucionais",
            "üöÄ Sistemas Web Personalizados",
            "üí∞ Solicitar Or√ßamento",
            "üë• Falar com Atendente"
        ];

        const quickActionsHTML = quickActions.map(action =>
            `<div class="quick-action" data-action="${action}">${action}</div>`
        ).join('');

        const quickActionsContainer = document.createElement('div');
        quickActionsContainer.className = 'quick-actions';
        quickActionsContainer.innerHTML = quickActionsHTML;

        document.getElementById('chatMessages').appendChild(quickActionsContainer);

        quickActionsContainer.querySelectorAll('.quick-action').forEach(button => {
            button.addEventListener('click', () => {
                const action = button.getAttribute('data-action');
                this.handleQuickAction(action);
            });
        });
    }

    handleQuickAction(action) {
        document.querySelector('.quick-actions')?.remove();

        this.addMessage({
            text: action,
            isBot: false,
            timestamp: new Date()
        });

        if (action.includes("üë• Falar com Atendente")) {
            this.transferToHuman();
        } else if (!this.humanChatActive) { // S√≥ responde com IA se n√£o estiver em modo humano
            this.generateBotResponse(action);
        }
    }

    sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (message && !this.isTyping) {
            document.querySelector('.quick-actions')?.remove();

            this.addMessage({
                text: message,
                isBot: false,
                timestamp: new Date()
            });

            input.value = '';
            this.autoResize();

            // üîí BLOQUEIO DA IA: Se est√° em modo humano, s√≥ usa WebSocket
            if (this.humanChatActive) {
                if (window.chatWebSocket) {
                    window.chatWebSocket.sendMessage(message);
                } else {
                    this.addMessage({
                        text: "‚ö†Ô∏è **Conex√£o perdida**\n\nTentando reconectar com o atendente...",
                        isBot: true,
                        timestamp: new Date()
                    });
                    this.initializeWebSocket();
                }
            } else {
                // Modo IA normal
                this.generateBotResponse(message);
            }
        }
    }

    addMessage(message) {
        const messagesContainer = document.getElementById('chatMessages');

        const messageElement = document.createElement('div');
        messageElement.className = `message ${message.isBot ? 'bot' : 'user'}`;

        const time = message.timestamp.toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit'
        });

        messageElement.innerHTML = `
            <div class="message-text">${this.formatMessage(message.text)}</div>
            <div class="message-time">${time}</div>
        `;

        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        this.messages.push(message);
        this.conversationContext.push({
            role: message.isBot ? 'assistant' : 'user',
            content: message.text
        });

        // Keep only last 10 messages for context
        if (this.conversationContext.length > 10) {
            this.conversationContext = this.conversationContext.slice(-10);
        }
    }

    formatMessage(text) {
        return text.replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');
    }

    showTypingIndicator() {
        this.isTyping = true;
        document.getElementById('chatTyping').classList.add('active');
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    }

    hideTypingIndicator() {
        this.isTyping = false;
        document.getElementById('chatTyping').classList.remove('active');
    }

    showTransferIndicator() {
        document.getElementById('chatTransfer').style.display = 'block';
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    }

    hideTransferIndicator() {
        document.getElementById('chatTransfer').style.display = 'none';
    }

    async generateBotResponse(userMessage) {
        // üîí BLOQUEIO: N√£o responde se est√° em modo humano
        if (this.humanChatActive) {
            return;
        }

        this.showTypingIndicator();

        try {
            const response = await this.getAIResponse(userMessage);

            setTimeout(() => {
                this.hideTypingIndicator();
                this.addMessage({
                    text: response,
                    isBot: true,
                    timestamp: new Date()
                });

                if (!this.waitingForHuman && !userMessage.includes('üë•')) {
                    setTimeout(() => this.showQuickActions(), 1000);
                }
            }, 1500 + Math.random() * 1000);

        } catch (error) {
            console.error('Erro na IA:', error);
            this.hideTypingIndicator();
            this.addMessage({
                text: "Desculpe, estou com dificuldades t√©cnicas. Por favor, tente novamente ou entre em contato diretamente pelo WhatsApp: (31) 99754-2811",
                isBot: true,
                timestamp: new Date()
            });
        }
    }

    async getAIResponse(userMessage) {
        // Primeiro, verifica se √© uma solicita√ß√£o de atendente humano
        if (this.shouldTransferToHuman(userMessage)) {
            this.transferToHuman();
            return "Perfeito! Vou conectar voc√™ com um de nossos especialistas humanos. Um momento por favor...";
        }

        // Tenta responder com base no contexto conhecido
        const contextualResponse = this.getContextualResponse(userMessage);
        if (contextualResponse) {
            return contextualResponse;
        }

        // Para mensagens fora do contexto, usa uma abordagem mais inteligente
        return this.handleUnknownQuery(userMessage);
    }

    transferToHuman() {
        this.pendingHumanTransfer = true; // ‚¨ÖÔ∏è MARCA QUE EST√Å AGUARDANDO FORMUL√ÅRIO

        // Esconde a√ß√µes r√°pidas
        document.querySelector('.quick-actions')?.remove();

        // Mostra formul√°rio de informa√ß√µes do cliente
        this.showClientInfoForm();
    }

    getContextualResponse(userMessage) {
        const lowerMessage = userMessage.toLowerCase();

        // Servi√ßos principais
        if (lowerMessage.includes('app') || lowerMessage.includes('aplicativo') || lowerMessage.includes('mobile')) {
            return this.getAppDevelopmentResponse();
        }

        if (lowerMessage.includes('site') || lowerMessage.includes('institucional') || lowerMessage.includes('landing page')) {
            return this.getWebDevelopmentResponse();
        }

        if (lowerMessage.includes('sistema') || lowerMessage.includes('plataforma') || lowerMessage.includes('software')) {
            return this.getSystemDevelopmentResponse();
        }

        if (lowerMessage.includes('or√ßamento') || lowerMessage.includes('pre√ßo') || lowerMessage.includes('custo') || lowerMessage.includes('valor')) {
            return this.getPricingResponse();
        }

        if (lowerMessage.includes('processo') || lowerMessage.includes('como funciona') || lowerMessage.includes('metodologia')) {
            return this.getProcessResponse();
        }

        if (lowerMessage.includes('tecnolog') || lowerMessage.includes('stack') || lowerMessage.includes('ferramenta')) {
            return this.getTechStackResponse();
        }

        // Perguntas sobre a empresa
        if (lowerMessage.includes('empresa') || lowerMessage.includes('wp web') || lowerMessage.includes('quem s√£o')) {
            return this.getCompanyResponse();
        }

        // Tempo e prazos
        if (lowerMessage.includes('tempo') || lowerMessage.includes('prazo') || lowerMessage.includes('quando') || lowerMessage.includes('dura')) {
            return this.getTimelineResponse();
        }

        return null;
    }

    handleUnknownQuery(userMessage) {
        // Analisa a inten√ß√£o da mensagem
        if (this.isGreeting(userMessage)) {
            return "Ol√°! üòä √â um prazer conversar com voc√™! Como posso ajudar com nossos servi√ßos de desenvolvimento?";
        }

        if (this.isThanks(userMessage)) {
            return "De nada! Fico feliz em ajudar. üòä H√° mais alguma coisa sobre nossos servi√ßos que gostaria de saber?";
        }

        if (this.isFarewell(userMessage)) {
            return "Obrigado pela conversa! Se tiver mais d√∫vidas sobre desenvolvimento, estarei aqui. Tenha um √≥timo dia! üåü";
        }

        // Para perguntas t√©cnicas complexas ou fora do escopo
        if (this.isTechnicalQuestion(userMessage)) {
            return `ü§î **Pergunta T√©cnica Interessante**

Sua pergunta sobre "${userMessage.substring(0, 50)}..." √© bastante espec√≠fica.

Para garantir uma resposta precisa e detalhada, recomendo:

1. **Conversar com nosso especialista t√©cnico** - posso conectar voc√™ agora mesmo
2. **Agendar uma call t√©cnica** - sem compromisso
3. **Enviar sua pergunta por email** para nossa equipe analisar

O que prefere? Posso transferir para um atendente humano que ter√° todo o conhecimento para ajudar!`;
        }

        // Resposta gen√©rica para mensagens n√£o reconhecidas
        return `ü§ñ **Assistente IA WP Web Solu√ß√µes**

Entendi que voc√™ perguntou sobre: "${userMessage}"

Como sou um assistente focado em **desenvolvimento de software**, posso ajudar melhor com:

‚Ä¢ Desenvolvimento de **apps, sites e sistemas**
‚Ä¢ **Tecnologias** que utilizamos (Flutter, React, Python, etc.)
‚Ä¢ **Processos** de desenvolvimento e prazos
‚Ä¢ **Or√ßamentos** e investimentos

Se sua pergunta for sobre outros assuntos ou precisar de um atendimento mais espec√≠fico, posso conectar voc√™ com nosso time humano!

**Como posso auxiliar melhor voc√™?**`;
    }

    // M√©todos de detec√ß√£o de inten√ß√£o
    isGreeting(message) {
        const greetings = ['oi', 'ol√°', 'ola', 'hey', 'e a√≠', 'eai', 'bom dia', 'boa tarde', 'boa noite'];
        return greetings.some(greet => message.toLowerCase().includes(greet));
    }

    isThanks(message) {
        const thanks = ['obrigado', 'obrigada', 'valeu', 'agrade√ßo', 'thanks', 'thank you'];
        return thanks.some(thank => message.toLowerCase().includes(thank));
    }

    isFarewell(message) {
        const farewells = ['tchau', 'bye', 'at√© mais', 'ate mais', 'flw', 'falou', 'adeus'];
        return farewells.some(farewell => message.toLowerCase().includes(farewell));
    }

    isTechnicalQuestion(message) {
        const techKeywords = ['como fazer', 'como implementar', 'melhor pr√°tica', 'arquitetura', 'api', 'database', 'backend', 'frontend'];
        return techKeywords.some(keyword => message.toLowerCase().includes(keyword));
    }

    // Respostas espec√≠ficas
    getAppDevelopmentResponse() {
        return `üì± **Desenvolvimento de Apps Mobile**

Desenvolvemos aplicativos **nativos e h√≠bridos** para iOS e Android:

**üöÄ Tecnologias:**
‚Ä¢ Flutter (Cross-platform)
‚Ä¢ React Native
‚Ä¢ Swift (iOS nativo)
‚Ä¢ Kotlin (Android nativo)

**üí° O que inclu√≠mos:**
‚Ä¢ Design UI/UX personalizado
‚Ä¢ Desenvolvimento completo
‚Ä¢ Integra√ß√£o com APIs
‚Ä¢ Publica√ß√£o nas lojas
‚Ä¢ Manuten√ß√£o cont√≠nua

**‚è±Ô∏è Tempo:** 2-4 meses
**üí∞ Investimento:** A partir de R$ 8.000

Tem um projeto espec√≠fico em mente?`;
    }

    getWebDevelopmentResponse() {
        return `üåê **Desenvolvimento Web**

Criamos **sites modernos e responsivos**:

**üé® Tipos de sites:**
‚Ä¢ Landing Pages (1-2 semanas)
‚Ä¢ Sites Institucionais (3-6 semanas)
‚Ä¢ E-commerce (4-8 semanas)
‚Ä¢ Portf√≥lios (2-4 semanas)

**‚ö° Tecnologias:**
‚Ä¢ HTML5/CSS3/JavaScript
‚Ä¢ React.js / Vue.js
‚Ä¢ WordPress (quando necess√°rio)
‚Ä¢ SEO otimizado

**üí∞ Investimento:** A partir de R$ 1.500

Qual tipo de site voc√™ precisa?`;
    }

    getSystemDevelopmentResponse() {
        return `üíª **Sistemas Web Sob Medida**

Desenvolvemos **sistemas completos** para automa√ß√£o empresarial:

**üõ†Ô∏è Stack Tecnol√≥gica:**
‚Ä¢ Frontend: React, Vue.js, TypeScript
‚Ä¢ Backend: Python/FastAPI, Node.js
‚Ä¢ Database: MongoDB, PostgreSQL
‚Ä¢ Cloud: AWS, Google Cloud, Oracle

**üìä Funcionalidades Comuns:**
‚Ä¢ Dashboards administrativos
‚Ä¢ Relat√≥rios em tempo real
‚Ä¢ Sistema de usu√°rios
‚Ä¢ Integra√ß√£o com APIs externas

**‚è±Ô∏è Tempo:** 2-5 meses
**üí∞ Investimento:** A partir de R$ 12.000

Para qual √°rea voc√™ precisa do sistema?`;
    }

    getPricingResponse() {
        return `üí∞ **Informa√ß√µes de Investimento**

**Site Institucional:** R$ 1.500 - R$ 8.000
‚Ä¢ Landing Page: R$ 1.500 - R$ 3.000
‚Ä¢ Site Corporativo: R$ 3.500 - R$ 8.000

**Aplicativo Mobile:** R$ 8.000 - R$ 25.000+
‚Ä¢ App Simples: R$ 8.000 - R$ 15.000  
‚Ä¢ App Complexo: R$ 15.000 - R$ 25.000+

**Sistema Web:** R$ 12.000 - R$ 50.000+
‚Ä¢ Sistema B√°sico: R$ 12.000 - R$ 25.000
‚Ä¢ Sistema Empresarial: R$ 25.000 - R$ 50.000+

**üíé Inclu√≠mos em todos os projetos:**
‚Ä¢ Design UI/UX personalizado
‚Ä¢ Desenvolvimento completo
‚Ä¢ Testes e qualidade
‚Ä¢ Deploy e implanta√ß√£o
‚Ä¢ Suporte p√≥s-entrega

Posso preparar uma estimativa personalizada?`;
    }

    getProcessResponse() {
        return `üîÑ **Nosso Processo de Desenvolvimento**

**1. Discovery (1-2 semanas)**
‚Ä¢ An√°lise de requisitos
‚Ä¢ Wireframes e prot√≥tipos
‚Ä¢ Planejamento detalhado

**2. Design (2-3 semanas)**
‚Ä¢ Design de interface
‚Ä¢ Experi√™ncia do usu√°rio
‚Ä¢ Valida√ß√£o com cliente

**3. Desenvolvimento (varia)**
‚Ä¢ Sprints de 2 semanas
‚Ä¢ Entregas parciais
‚Ä¢ Testes cont√≠nuos

**4. Entrega & Suporte**
‚Ä¢ Deploy e implanta√ß√£o
‚Ä¢ Treinamento
‚Ä¢ Suporte p√≥s-entrega

**üéØ Taxa de satisfa√ß√£o:** 95% dos clientes`;
    }

    getTechStackResponse() {
        return `üõ†Ô∏è **Stack Tecnol√≥gica**

**Frontend:**
‚Ä¢ React.js / Vue.js / TypeScript
‚Ä¢ Flutter / React Native
‚Ä¢ HTML5 / CSS3 / JavaScript

**Backend:**
‚Ä¢ Python + FastAPI
‚Ä¢ Node.js + Express
‚Ä¢ PHP + Laravel

**Database:**
‚Ä¢ MongoDB
‚Ä¢ PostgreSQL
‚Ä¢ MySQL

**Cloud & DevOps:**
‚Ä¢ AWS / Google Cloud
‚Ä¢ Docker
‚Ä¢ CI/CD

**Ferramentas de IA:**
‚Ä¢ TensorFlow
‚Ä¢ OpenAI API
‚Ä¢ Processamento de linguagem natural

Tem prefer√™ncia por alguma tecnologia espec√≠fica?`;
    }

    getCompanyResponse() {
        return `üè¢ **WP Web Solu√ß√µes**

Somos uma empresa especializada em **desenvolvimento de software** com foco em:

**üéØ Nossa Miss√£o:**
Transformar ideias em solu√ß√µes digitais inovadoras que impulsionam neg√≥cios

**üíº O que fazemos:**
‚Ä¢ Desenvolvimento de aplicativos mobile
‚Ä¢ Cria√ß√£o de sites e sistemas web
‚Ä¢ Solu√ß√µes com intelig√™ncia artificial
‚Ä¢ Consultoria em tecnologia

**‚≠ê Diferenciais:**
‚Ä¢ Metodologia √°gil transparente
‚Ä¢ Tecnologias modernas
‚Ä¢ Suporte cont√≠nuo
‚Ä¢ Mais de 50 projetos entregues

**üìç Localiza√ß√£o:** Minas Gerais, MG - Brasil

H√° mais de 5 anos entregando excel√™ncia em desenvolvimento!`;
    }

    getTimelineResponse() {
        return `‚è±Ô∏è **Prazos de Desenvolvimento**

**Landing Page:** 1-2 semanas
**Site Institucional:** 3-6 semanas  
**E-commerce:** 4-8 semanas
**Aplicativo Mobile:** 2-4 meses
**Sistema Web:** 2-5 meses

**üìÖ Fatores que influenciam o prazo:**
‚Ä¢ Complexidade do projeto
‚Ä¢ N√∫mero de funcionalidades
‚Ä¢ Integra√ß√µes necess√°rias
‚Ä¢ Revis√µes solicitadas

**‚ö° Aceleramos projetos** quando necess√°rio!

Qual tipo de projeto voc√™ tem em mente?`;
    }

    // NOVO: Atualiza interface para modo humano
    updateInterfaceForHumanMode() {
        document.getElementById('chatAgentName').textContent = 'Atendente';
        document.getElementById('chatAgentStatus').textContent = 'Online ‚Ä¢ Em atendimento';

        // Remove qualquer a√ß√£o r√°pida da IA
        document.querySelector('.quick-actions')?.remove();
    }

    // NOVO: M√©todo para voltar para a IA (quando atendente desconecta)
    returnToAIMode() {
        this.humanChatActive = false;
        this.waitingForHuman = false;
        this.saveState();

        document.getElementById('chatAgentName').textContent = 'Assistente IA';
        document.getElementById('chatAgentStatus').textContent = 'Online ‚Ä¢ WP Web Solu√ß√µes';

        this.addMessage({
            text: "üîÑ **Retornando para o modo assistente IA**\n\nO atendimento humano foi encerrado. Como posso ajudar voc√™ agora?",
            isBot: true,
            timestamp: new Date()
        });

        this.showQuickActions();
    }

    transferToHuman() {
        this.pendingHumanTransfer = true; // ‚¨ÖÔ∏è MARCA QUE EST√Å AGUARDANDO FORMUL√ÅRIO

        // Esconde a√ß√µes r√°pidas
        document.querySelector('.quick-actions')?.remove();

        // Mostra formul√°rio de informa√ß√µes do cliente
        this.showClientInfoForm();
    }

    initializeWebSocket() {
        if (!window.chatWebSocket) {
            window.chatWebSocket = new ChatWebSocket(this);
        }
        window.chatWebSocket.connect();
    }

    // NOVO: M√©todo para mostrar formul√°rio de informa√ß√µes do cliente
    showClientInfoForm() {
        const formHTML = `
        <div class="client-info-form" id="clientInfoForm">
            <div class="form-header">
                <h4>üìã Antes de conectar com nosso atendente</h4>
                <p>Preencha suas informa√ß√µes para agilizar o atendimento:</p>
            </div>
            
            <div class="form-fields">
                <div class="form-group">
                    <label for="clientName">Seu Nome *</label>
                    <input type="text" id="clientName" placeholder="Como gostaria de ser chamado?" required>
                </div>
                
                <div class="form-group">
                    <label for="clientEmail">E-mail *</label>
                    <input type="email" id="clientEmail" placeholder="seu@email.com" required>
                </div>
                
                <div class="form-group">
                    <label for="clientPhone">Telefone/WhatsApp *</label>
                    <input type="tel" id="clientPhone" placeholder="(00) 00000-0000" required>
                </div>
                
                <div class="form-group">
                    <label for="clientProject">Tipo de Projeto</label>
                    <select id="clientProject">
                        <option value="">Selecione uma op√ß√£o</option>
                        <option value="app">Aplicativo Mobile</option>
                        <option value="site">Site Institucional</option>
                        <option value="ecommerce">Loja Virtual (E-commerce)</option>
                        <option value="sistema">Sistema Web</option>
                        <option value="landing">Landing Page</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="clientUrgency">Urg√™ncia do Projeto</label>
                    <select id="clientUrgency">
                        <option value="baixa">Baixa - Apenas or√ßamentando</option>
                        <option value="media">M√©dia - In√≠cio em 1-2 meses</option>
                        <option value="alta">Alta - In√≠cio imediato</option>
                    </select>
                </div>
                
                <div class="form-group full-width">
                    <label for="clientMessage">Mensagem para o atendente</label>
                    <textarea 
                        id="clientMessage" 
                        placeholder="Conte um pouco sobre seu projeto, objetivos ou d√∫vidas espec√≠ficas..."
                        rows="3"
                    ></textarea>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn-cancel" id="cancelFormBtn">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="btn-submit" id="submitFormBtn">
                    <i class="fas fa-user-headset"></i>
                    Conectar com Atendente
                </button>
            </div>
            
            <div class="form-footer">
                <p><small>‚ö†Ô∏è Seus dados est√£o seguros e ser√£o usados apenas para este atendimento.</small></p>
            </div>
        </div>
    `;

        const formContainer = document.createElement('div');
        formContainer.className = 'message bot';
        formContainer.innerHTML = `
        <div class="message-text">
            ${formHTML}
        </div>
        <div class="message-time">${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
    `;

        document.getElementById('chatMessages').appendChild(formContainer);
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;

        // Adiciona eventos ao formul√°rio
        this.bindFormEvents();
    }

    // NOVO: M√©todo para vincular eventos do formul√°rio
    bindFormEvents() {
        const cancelBtn = document.getElementById('cancelFormBtn');
        const submitBtn = document.getElementById('submitFormBtn');

        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                const formElement = document.getElementById('clientInfoForm');
                if (formElement) {
                    formElement.closest('.message').remove();
                }
                this.pendingHumanTransfer = false;
                this.addMessage({
                    text: "‚ùå **Solicita√ß√£o cancelada**\n\nVoc√™ cancelou a solicita√ß√£o de atendimento humano. Como posso ajud√°-lo com nossa IA?",
                    isBot: true,
                    timestamp: new Date()
                });
                this.showQuickActions();
            });
        }

        if (submitBtn) {
            submitBtn.addEventListener('click', () => {
                this.submitClientInfoForm();
            });
        }

        // Enter para submeter formul√°rio
        const form = document.getElementById('clientInfoForm');
        if (form) {
            form.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    this.submitClientInfoForm();
                }
            });
        }
    }

    // NOVO: M√©todo para submeter formul√°rio
    submitClientInfoForm() {
        const nameInput = document.getElementById('clientName');
        const emailInput = document.getElementById('clientEmail');
        const phoneInput = document.getElementById('clientPhone');

        if (!nameInput || !emailInput || !phoneInput) {
            console.error('Campos do formul√°rio n√£o encontrados');
            return;
        }

        const name = nameInput.value.trim();
        const email = emailInput.value.trim();
        const phone = phoneInput.value.trim();
        const project = document.getElementById('clientProject').value;
        const urgency = document.getElementById('clientUrgency').value;
        const message = document.getElementById('clientMessage').value.trim();

        const timeOnPage = Math.round((Date.now() - this.startTime) / 1000);
¬† ¬† ¬† ¬† const origin = document.referrer || 'Acesso Direto';

        // Valida√ß√£o b√°sica
        if (!name || !email || !phone) {
            this.showFormError('Por favor, preencha pelo menos nome, e-mail e telefone.');
            return;
        }

        if (!this.validateEmail(email)) {
            this.showFormError('Por favor, insira um e-mail v√°lido.');
            return;
        }

        // Remove o formul√°rio
        const formElement = document.getElementById('clientInfoForm');
        if (formElement) {
            formElement.closest('.message').remove();
        }

        // Adiciona mensagem de confirma√ß√£o
        this.addMessage({
            text: `üìã **Informa√ß√µes enviadas!**\n\nObrigado, ${name}! Suas informa√ß√µes foram recebidas e j√° estamos conectando voc√™ com um de nossos especialistas.`,
            isBot: true,
            timestamp: new Date()
        });

        // Prepara dados para envio
        const clientData = {
            name,
            email,
            phone,
            project,
            urgency,
            message,
            timeOnPage: `${timeOnPage} segundos`,
            source: origin,
            page: window.location.href,
            timestamp: new Date().toISOString(),
            sessionId: this.sessionId
        };

        // Inicia a transfer√™ncia real
        this.startHumanTransfer(clientData);
    }

    // NOVO: M√©todo para validar e-mail
    validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // NOVO: M√©todo para mostrar erro no formul√°rio
    showFormError(message) {
        let errorElement = document.getElementById('formError');

        if (!errorElement) {
            errorElement = document.createElement('div');
            errorElement.id = 'formError';
            errorElement.className = 'form-error';
            const form = document.getElementById('clientInfoForm');
            if (form) {
                form.insertBefore(errorElement, form.querySelector('.form-actions'));
            }
        }

        errorElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
        errorElement.style.display = 'block';

        // Scroll para o erro
        errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // NOVO: M√©todo para iniciar transfer√™ncia com dados do cliente
    // CORRIGIDO: M√©todo para iniciar transfer√™ncia com dados do cliente
¬† ¬† startHumanTransfer(clientData) {
¬† ¬† ¬† ¬† this.waitingForHuman = true;
¬† ¬† ¬† ¬† this.humanChatActive = true;
¬† ¬† ¬† ¬† this.pendingHumanTransfer = false;
¬† ¬† ¬† ¬† this.saveState();

¬† ¬† ¬† ¬† this.showTransferIndicator();

¬† ¬† ¬† ¬† document.getElementById('chatAgentName').textContent = 'Conectando...';
¬† ¬† ¬† ¬† document.getElementById('chatAgentStatus').textContent = 'Transferindo para atendente';

¬† ¬† ¬† ¬† // A linha do bug "conversationContext.push" foi removida daqui.

¬† ¬† ¬† ¬† // Adiciona mensagem de transi√ß√£o
¬† ¬† ¬† ¬† this.addMessage({
¬† ¬† ¬† ¬† ¬† ¬† text: "üîÑ **Conectando com atendente humano...**\n\nAguarde um momento enquanto conectamos voc√™ com um de nossos especialistas.",
¬† ¬† ¬† ¬† ¬† ¬† isBot: true,
¬† ¬† ¬† ¬† ¬† ¬† timestamp: new Date()
¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† // Inicializa WebSocket com dados do cliente
¬† ¬† ¬† ¬† this.initializeWebSocket(clientData);
¬† ¬† }

    // ATUALIZADO: M√©todo initializeWebSocket para aceitar dados do cliente
    initializeWebSocket(clientData = null) {
        if (!window.chatWebSocket) {
            window.chatWebSocket = new ChatWebSocket(this);
        }

        // Passa os dados do cliente para o WebSocket
        if (clientData) {
            window.chatWebSocket.clientData = clientData;
        }

        window.chatWebSocket.connect();
    }
}

// Initialize chat when DOM is loaded
document.addEventListener('DOMContentLoaded', function () {
    window.chatIA = new ChatIA();
    console.log('‚úÖ Chat IA inicializado com sucesso');
});